<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ph√¢n T√≠ch Baccarat To√†n Di·ªán (AI Council)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c101b;
            color: #F9FAFB;
        }
        .btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn:active:not(:disabled) { transform: translateY(1px); }
         .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .card-glow-p { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .card-glow-b { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
        .card-glow-wait { box-shadow: 0 0 20px rgba(156, 163, 175, 0.4); }

        .road-grid {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: 24px;
            gap: 2px;
            overflow-x: auto;
            padding: 8px;
            min-height: 160px;
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        .road-col {
            display: grid;
            grid-auto-rows: 24px;
            gap: 2px;
        }
        .road-item {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: white;
            position: relative;
        }
        .road-item-big { border-radius: 9999px; border: 2px solid; }
        .road-item-p { border-color: #3b82f6; color: #3b82f6; }
        .road-item-b { border-color: #ef4444; color: #ef4444; }
        .road-item-t { background-color: #10b981; border-radius: 9999px; }

        /* Tie Slash */
        .tie-slash {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: #10b981;
            transform: rotate(-45deg);
        }

        /* Pair Dots */
        .pair-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .pair-dot.p-pair { background-color: #3b82f6; top: 2px; right: 2px; }
        .pair-dot.b-pair { background-color: #ef4444; bottom: 2px; left: 2px; }

        .bead-plate-item-p { background-color: #3b82f6; border-radius: 9999px;}
        .bead-plate-item-b { background-color: #ef4444; border-radius: 9999px;}
        
        /* Corrected Derived Road Styles */
        .derived-item { width: 10px; height: 10px; }
        .big-eye-boy-p { border: 2px solid #3b82f6; border-radius: 9999px; } /* Blue for Pattern */
        .big-eye-boy-b { border: 2px solid #ef4444; border-radius: 9999px; } /* Red for Choppy */
        .small-road-p { background-color: #3b82f6; border-radius: 9999px; } /* Blue for Pattern */
        .small-road-b { background-color: #ef4444; } /* Red for Choppy */
        .cockroach-pig-p { border: 1px solid #3b82f6; background: linear-gradient(to top right, transparent calc(50% - 0.5px), #3b82f6, transparent calc(50% + 0.5px)); } /* Blue for Pattern */
        .cockroach-pig-b { border: 1px solid #ef4444; background: linear-gradient(to top right, transparent calc(50% - 0.5px), #ef4444, transparent calc(50% + 0.5px)); } /* Red for Choppy */
        
        .pair-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-900">
<div id="toast-container"></div>

<div class="max-w-screen-xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left Column: Input & History -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Header -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg text-center">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-red-400">H·ªá Th·ªëng Ph√¢n T√≠ch Baccarat (AI Council)</h1>
            <p class="text-gray-400 mt-2">S·ª©c m·∫°nh c·ªßa H·ªôi ƒê·ªìng 10 Chuy√™n Gia AI</p>
        </div>
        
        <!-- Controls -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold text-blue-300">‚öôÔ∏è B·∫£ng ƒêi·ªÅu Khi·ªÉn</h2>
                 <button onclick="openSettingsModal()" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-cog fa-lg"></i></button>
             </div>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <button onclick="addResult('P')" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-6 rounded-lg text-2xl">
                    <span>üë§</span> CON
                </button>
                 <button onclick="addResult('T')" class="btn bg-green-600 hover:bg-green-500 text-white font-bold py-6 rounded-lg text-2xl">
                    <span>ü§ù</span> H√íA
                </button>
                <button onclick="addResult('B')" class="btn bg-red-600 hover:bg-red-500 text-white font-bold py-6 rounded-lg text-2xl">
                    <span>üè¶</span> C√ÅI
                </button>
            </div>

            <div class="flex items-center justify-center gap-6 mb-4 text-white">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="playerPair" class="w-5 h-5 rounded border-2 border-blue-400 text-blue-500 focus:ring-blue-500 pair-checkbox appearance-none">
                    <span>Con ƒê√¥i</span>
                </label>
                 <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="bankerPair" class="w-5 h-5 rounded border-2 border-red-400 text-red-500 focus:ring-red-500 pair-checkbox appearance-none">
                    <span>C√°i ƒê√¥i</span>
                </label>
            </div>

            <div class="flex gap-4">
                <button onclick="undoLast()" class="btn flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">‚Ü©Ô∏è Ho√†n T√°c</button>
                <button onclick="clearHistory()" class="btn flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg">üóëÔ∏è X√≥a L·ªãch S·ª≠</button>
            </div>
        </div>

        <!-- History Display -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-blue-300">üìú C√°c B·∫£ng C·∫ßu</h2>
                    <span class="text-gray-400 font-medium text-sm">T·ªïng: <span id="totalGames">0</span> v√°n</span>
                </div>
                <div id="statsContainer" class="text-right text-xs space-y-1 text-gray-300 bg-gray-900/50 p-2 rounded-md"></div>
            </div>

            <div class="grid grid-cols-12 gap-2">
                <!-- Main Roads -->
                <div class="col-span-12 md:col-span-8 space-y-2">
                    <div class="bg-gray-900 rounded-lg border border-gray-700"><div id="beadPlateDisplay" class="road-grid"></div></div>
                    <div class="bg-gray-900 rounded-lg border border-gray-700"><div id="bigRoadDisplay" class="road-grid"></div></div>
                </div>
                <!-- Derived Roads -->
                <div class="col-span-12 md:col-span-4 space-y-2">
                    <div class="bg-gray-900 rounded-lg border border-gray-700 grid grid-cols-2">
                        <div id="bigEyeBoyDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1"></div>
                        <div id="pAskDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1 border-l-2 border-gray-700"></div>
                    </div>
                     <div class="bg-gray-900 rounded-lg border border-gray-700 grid grid-cols-2">
                        <div id="smallRoadDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1"></div>
                        <div id="bAskDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1 border-l-2 border-gray-700"></div>
                    </div>
                     <div class="bg-gray-900 rounded-lg border border-gray-700"><div id="cockroachPigDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Analysis & Stats -->
    <div class="space-y-6">
        <div id="analysis-card" class="bg-gray-800 p-6 rounded-2xl shadow-lg transition-shadow duration-500 sticky top-6">
            <h2 class="text-xl font-semibold mb-4 text-yellow-300 flex items-center gap-2">
                <i class="fa-solid fa-brain"></i> Ph√°n Quy·∫øt H·ªôi ƒê·ªìng AI
            </h2>
            <div id="analysisResult" class="space-y-4 min-h-[170px] flex flex-col justify-center">
                <!-- AI content goes here -->
            </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-blue-300">üìä Th·ªëng K√™ ƒê·ªÅ Xu·∫•t (Phi√™n)</h2>
            <div id="predictionStats" class="grid grid-cols-4 gap-2 text-center mb-4"></div>
            <div id="predictionChart" class="w-full h-24 bg-gray-900 rounded-lg p-2 flex items-end gap-1 overflow-x-auto"></div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden"></div>

<script>
// --- GLOBAL STATE & CONFIG ---
let state = {
    history: [],
    apiKeys: Array(10).fill(''),
    isAnalyzing: false,
    lastPrediction: null,
    predictions: [], 
};
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
const MIN_HISTORY_FOR_ANALYSIS = 10;

// --- ROADMAP LOGIC ---
class BaccaratRoadmapGenerator {
    generateBigRoad(history) {
        const columns = []; if (history.length === 0) return columns;
        let currentCol = []; let lastWinner = null;
        history.forEach(item => {
            if (item.winner === 'T') {
                if (currentCol.length > 0) { currentCol[currentCol.length - 1].ties = (currentCol[currentCol.length - 1].ties || 0) + 1; } 
                else if (columns.length > 0) { const prevCol = columns[columns.length - 1]; prevCol[prevCol.length - 1].ties = (prevCol[prevCol.length - 1].ties || 0) + 1; }
            } else {
                const bead = { winner: item.winner, pPair: item.pPair, bPair: item.bPair, ties: 0 };
                if (item.winner === lastWinner) { currentCol.push(bead); } 
                else { if (currentCol.length > 0) columns.push(currentCol); currentCol = [bead]; lastWinner = item.winner; }
            }
        });
        if (currentCol.length > 0) columns.push(currentCol); return columns;
    }
    generateDerivedRoads(bigRoad, hypotheticalWinner = null) {
        let tempBigRoad = JSON.parse(JSON.stringify(bigRoad));
        if (hypotheticalWinner) {
            const lastCol = tempBigRoad.length > 0 ? tempBigRoad[tempBigRoad.length - 1] : null;
            if (lastCol && lastCol[0].winner === hypotheticalWinner) { lastCol.push({ winner: hypotheticalWinner }); } 
            else { tempBigRoad.push([{ winner: hypotheticalWinner }]); }
        }
        const results = { bigEyeBoy: [], smallRoad: [], cockroachPig: [] };
        for (let i = 0; i < tempBigRoad.length; i++) {
            for (let j = 0; j < tempBigRoad[i].length; j++) {
                if (i >= 1 && (j > 0 || (j === 0 && tempBigRoad[i-1].length > 1))) this.addDerivedResult(results.bigEyeBoy, tempBigRoad, i, j, 1);
                if (i >= 2) this.addDerivedResult(results.smallRoad, tempBigRoad, i, j, 2);
                if (i >= 3) this.addDerivedResult(results.cockroachPig, tempBigRoad, i, j, 3);
            }
        }
        return results;
    }
    addDerivedResult(road, bigRoad, i, j, offset) { const result = this.compare(bigRoad, i, j, offset); if (result) road.push(result); }
    compare(bigRoad, i, j, offset) {
        let isPattern;
        const refColIndex = i - offset;
        if (refColIndex < 0) return null;
        
        if (j === 0) {
            const prevCol = bigRoad[i - 1]; 
            const refCol = bigRoad[refColIndex]; 
            if (!prevCol || !refCol) return null;
            isPattern = prevCol.length === refCol.length;
        } else {
            const refCol = bigRoad[refColIndex];
            if (!refCol) return null;
            const hasRefBeadAtDepth = !!refCol[j];
            const hasRefBeadAtPrevDepth = !!refCol[j-1];

            if(hasRefBeadAtDepth) {
                isPattern = true;
            } else {
                isPattern = !hasRefBeadAtPrevDepth;
            }
        }
        return { winner: isPattern ? 'P' : 'B' };
    }
}
const roadmapGenerator = new BaccaratRoadmapGenerator();

// --- UI RENDERING ---
function renderAllRoads() {
    const bigRoad = roadmapGenerator.generateBigRoad(state.history);
    renderBeadPlateUI(state.history);
    renderBigRoadUI(bigRoad);
    const derivedRoads = roadmapGenerator.generateDerivedRoads(bigRoad);
    renderDerivedRoadUI('bigEyeBoyDisplay', derivedRoads.bigEyeBoy, 'big-eye-boy');
    renderDerivedRoadUI('smallRoadDisplay', derivedRoads.smallRoad, 'small-road');
    renderDerivedRoadUI('cockroachPigDisplay', derivedRoads.cockroachPig, 'cockroach-pig');
    updatePredictionProbes(bigRoad);
    updateStatsUI(state.history);
}

function renderBeadPlateUI(data) {
    const container = document.getElementById('beadPlateDisplay'); container.innerHTML = '';
    const maxRows = 6; let currentCol = document.createElement('div'); currentCol.className = 'road-col';
    data.forEach((item, index) => {
        if (index > 0 && index % maxRows === 0) { container.appendChild(currentCol); currentCol = document.createElement('div'); currentCol.className = 'road-col'; }
        const itemDiv = document.createElement('div');
        const colorClass = item.winner === 'P' ? 'bead-plate-item-p' : item.winner === 'B' ? 'bead-plate-item-b' : 'road-item-t';
        itemDiv.className = `road-item ${colorClass}`; itemDiv.textContent = item.winner;
        if (item.pPair) itemDiv.innerHTML += '<div class="pair-dot p-pair"></div>'; if (item.bPair) itemDiv.innerHTML += '<div class="pair-dot b-pair"></div>';
        currentCol.appendChild(itemDiv);
    });
    if (currentCol.hasChildNodes()) container.appendChild(currentCol); container.scrollLeft = container.scrollWidth;
}

function renderBigRoadUI(columns) {
    const container = document.getElementById('bigRoadDisplay'); container.innerHTML = '';
    columns.forEach(colData => {
        const colDiv = document.createElement('div'); colDiv.className = 'road-col';
        colData.forEach(item => {
            const itemDiv = document.createElement('div'); itemDiv.className = `road-item road-item-big road-item-${item.winner.toLowerCase()}`;
            if (item.pPair) itemDiv.innerHTML += '<div class="pair-dot p-pair"></div>'; if (item.bPair) itemDiv.innerHTML += '<div class="pair-dot b-pair"></div>';
            if (item.ties > 0) { itemDiv.innerHTML += `<div class="tie-slash"></div>`; if(item.ties > 1) itemDiv.innerHTML += `<span class="absolute text-xs font-bold text-white">${item.ties}</span>`; }
            colDiv.appendChild(itemDiv);
        });
        container.appendChild(colDiv);
    });
    container.scrollLeft = container.scrollWidth;
}

function renderDerivedRoadUI(containerId, data, type) {
    const container = document.getElementById(containerId); container.innerHTML = ''; if (data.length === 0) return;
    const columns = roadmapGenerator.generateBigRoad(data);
    columns.forEach(colData => {
        const colDiv = document.createElement('div'); colDiv.className = 'road-col !grid-auto-rows-[10px]';
        colData.forEach(item => {
            const itemDiv = document.createElement('div'); const color = item.winner.toLowerCase();
            itemDiv.className = `derived-item ${type}-${color}`; colDiv.appendChild(itemDiv);
        });
        container.appendChild(colDiv);
    });
    container.scrollLeft = container.scrollWidth;
}

function updatePredictionProbes(bigRoad) {
    const pAskContainer = document.getElementById('pAskDisplay'); const bAskContainer = document.getElementById('bAskDisplay');
    pAskContainer.innerHTML = ''; bAskContainer.innerHTML = '';
    const pProbeRoads = roadmapGenerator.generateDerivedRoads(bigRoad, 'P');
    const pBigEyeNext = pProbeRoads.bigEyeBoy.pop(); const pSmallNext = pProbeRoads.smallRoad.pop(); const pCockroachNext = pProbeRoads.cockroachPig.pop();
    let pAskHTML = '<div class="road-col !grid-auto-rows-[10px] !gap-0.5">';
    if (pBigEyeNext) pAskHTML += `<div class="derived-item big-eye-boy-${pBigEyeNext.winner.toLowerCase()}"></div>`;
    if (pSmallNext) pAskHTML += `<div class="derived-item small-road-${pSmallNext.winner.toLowerCase()}"></div>`;
    if (pCockroachNext) pAskHTML += `<div class="derived-item cockroach-pig-${pCockroachNext.winner.toLowerCase()}"></div>`;
    pAskContainer.innerHTML = pAskHTML + '</div>';
    const bProbeRoads = roadmapGenerator.generateDerivedRoads(bigRoad, 'B');
    const bBigEyeNext = bProbeRoads.bigEyeBoy.pop(); const bSmallNext = bProbeRoads.smallRoad.pop(); const bCockroachNext = bProbeRoads.cockroachPig.pop();
    let bAskHTML = '<div class="road-col !grid-auto-rows-[10px] !gap-0.5">';
    if (bBigEyeNext) bAskHTML += `<div class="derived-item big-eye-boy-${bBigEyeNext.winner.toLowerCase()}"></div>`;
    if (bSmallNext) bAskHTML += `<div class="derived-item small-road-${bSmallNext.winner.toLowerCase()}"></div>`;
    if (bCockroachNext) bAskHTML += `<div class="derived-item cockroach-pig-${bCockroachNext.winner.toLowerCase()}"></div>`;
    bAskContainer.innerHTML = bAskHTML + '</div>';
}

function updateStatsUI(history) {
    const stats = { P: 0, B: 0, T: 0, pPair: 0, bPair: 0 };
    history.forEach(h => { stats[h.winner] = (stats[h.winner] || 0) + 1; if(h.pPair) stats.pPair++; if(h.bPair) stats.bPair++; });
    document.getElementById('statsContainer').innerHTML = `<div>C: ${stats.P}</div><div>B: ${stats.B}</div><div>H: ${stats.T}</div><div>Cƒê: ${stats.pPair}</div><div>Bƒê: ${stats.bPair}</div>`;
}

function renderStatsAndChart() {
    const statsContainer = document.getElementById('predictionStats');
    const chartContainer = document.getElementById('predictionChart');
    if (!statsContainer || !chartContainer) return;
    const wins = state.predictions.filter(p => p.outcome === 'win').length;
    const losses = state.predictions.length - wins;
    const total = state.predictions.length;
    const winRate = total > 0 ? ((wins / total) * 100).toFixed(1) : "0.0";
    statsContainer.innerHTML = `
        <div><p class="text-sm text-gray-400">ƒê√∫ng</p><p class="text-2xl font-bold text-green-400">${wins}</p></div>
        <div><p class="text-sm text-gray-400">Sai</p><p class="text-2xl font-bold text-red-400">${losses}</p></div>
        <div><p class="text-sm text-gray-400">T·ªïng</p><p class="text-2xl font-bold">${total}</p></div>
        <div><p class="text-sm text-gray-400">T·ª∑ L·ªá</p><p class="text-2xl font-bold text-yellow-400">${winRate}%</p></div>`;
    chartContainer.innerHTML = '';
    state.predictions.slice(-50).forEach(p => {
        const bar = document.createElement('div');
        const isWin = p.outcome === 'win';
        bar.className = `flex-shrink-0 w-2.5 rounded-sm transition-all duration-300 ${isWin ? 'h-full bg-green-500' : 'h-1/3 bg-red-500'}`;
        bar.title = `ƒê·ªÅ xu·∫•t: ${p.prediction}, Th·ª±c t·∫ø: ${p.actual} - ${isWin ? 'ƒê√∫ng' : 'Sai'}`;
        chartContainer.appendChild(bar);
    });
    chartContainer.scrollLeft = chartContainer.scrollWidth;
}

// --- CORE ACTIONS ---
function addResult(winner) {
    if (state.isAnalyzing) return;
    const pPair = document.getElementById('playerPair').checked;
    const bPair = document.getElementById('bankerPair').checked;
    
    if (state.lastPrediction && winner !== 'T') {
        const outcome = state.lastPrediction.prediction === winner ? 'win' : 'loss';
        state.predictions.push({ prediction: state.lastPrediction.prediction, actual: winner, outcome });
    }
    
    state.lastPrediction = null; 
    state.history.push({ winner, pPair, bPair });
    document.getElementById('totalGames').textContent = state.history.length;
    document.getElementById('playerPair').checked = false;
    document.getElementById('bankerPair').checked = false;
    renderAllRoads();
    renderStatsAndChart();
    saveState();
    
    triggerAIAnalysis();
}

function undoLast() {
    if (state.isAnalyzing) return;
    if (state.lastPrediction) {
        state.lastPrediction = null;
    } else if (state.history.length > 0) {
        state.history.pop();
        if (state.predictions.length > 0 && state.predictions[state.predictions.length - 1].actual) {
             state.predictions.pop();
        }
    }
    
    triggerAIAnalysis();
    document.getElementById('totalGames').textContent = state.history.length;
    renderAllRoads();
    renderStatsAndChart();
    saveState();
}

function clearHistory() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ v√† th·ªëng k√™ kh√¥ng?')) {
        state.history = []; 
        state.predictions = []; 
        state.lastPrediction = null;
        document.getElementById('totalGames').textContent = 0;
        renderAllRoads();
        renderStatsAndChart();
        initializeAppUI();
        saveState();
    }
}

// --- AI & SETTINGS ---
function openSettingsModal() {
    const modal = document.getElementById('settingsModal'); 
    modal.classList.remove('hidden');
    let apiInputsHTML = '';
    state.apiKeys.forEach((key, index) => {
        apiInputsHTML += `<input type="password" id="modalApiKey${index+1}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none mt-2" value="${key}" placeholder="API Key ${index + 1}">`;
    });
    modal.innerHTML = `<div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md"> <div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-bold text-blue-300">C√†i ƒê·∫∑t H·ªôi ƒê·ªìng AI</h2> <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-white text-3xl">&times;</button> </div> <div> <label class="block text-sm font-medium text-gray-300 mb-2">10 Gemini API Keys</label> ${apiInputsHTML} <p class="text-xs text-gray-500 mt-2">API Keys ƒë∆∞·ª£c l∆∞u tr√™n tr√¨nh duy·ªát. <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">L·∫•y API Key</a>.</p> </div> <div class="mt-8 flex justify-end gap-4"> <button onclick="closeSettingsModal()" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">H·ªßy</button> <button onclick="saveSettings()" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg">L∆∞u</button> </div> </div>`;
}
function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); }
function saveSettings() {
    state.apiKeys = Array.from({length: 10}, (_, i) => document.getElementById(`modalApiKey${i+1}`).value.trim());
    saveState(); 
    closeSettingsModal();
    triggerAIAnalysis();
}
function saveState() { localStorage.setItem('baccaratAI_Council_state_v1', JSON.stringify(state)); }
function loadState() {
    const savedState = localStorage.getItem('baccaratAI_Council_state_v1');
    if (savedState) { 
        const loaded = JSON.parse(savedState);
        loaded.apiKeys = (loaded.apiKeys || []).concat(Array(10).fill('')).slice(0, 10);
        Object.assign(state, loaded); 
    }
}

async function triggerAIAnalysis() {
    if (state.isAnalyzing) return;
    if (state.apiKeys.some(key => !key)) { 
        updateAnalysisUI(`<div class="text-center"><p class="text-yellow-400 font-semibold">Vui l√≤ng nh·∫≠p ƒë·ªß 10 API Key!</p><p class="text-gray-400 mt-2 text-sm">Click icon <i class="fas fa-cog"></i> ƒë·ªÉ c√†i ƒë·∫∑t.</p></div>`); 
        return; 
    }
    if (state.history.length < MIN_HISTORY_FOR_ANALYSIS) { 
        updateAnalysisUI(`<p class="text-gray-400 text-center">C·∫ßn √≠t nh·∫•t ${MIN_HISTORY_FOR_ANALYSIS} v√°n ƒë·ªÉ H·ªôi ƒë·ªìng b·∫Øt ƒë·∫ßu l√†m vi·ªác.</p>`); 
        return; 
    }
    
    state.isAnalyzing = true;
    updateAnalysisUI(`<div class="flex flex-col items-center justify-center h-full"><div class="w-8 h-8 border-4 border-t-blue-500 border-gray-600 rounded-full animate-spin"></div><p class="text-gray-400 mt-3 animate-pulse">H·ªôi ƒë·ªìng AI ƒëang h·ªçp...</p></div>`);
    
    try {
        const historySnippet = `[${state.history.map(h=>h.winner).slice(-50).join(', ')}]... (T·ªïng ${state.history.length} v√°n)`;
        
        const specialistPrompts = getSpecialistPrompts(historySnippet);
        const specialistPromises = [
            callGemini(specialistPrompts.ai1.system, specialistPrompts.ai1.user, state.apiKeys[0]),
            callGemini(specialistPrompts.ai2.system, specialistPrompts.ai2.user, state.apiKeys[1]),
            callGemini(specialistPrompts.ai3.system, specialistPrompts.ai3.user, state.apiKeys[2]),
            callGemini(specialistPrompts.ai4.system, specialistPrompts.ai4.user, state.apiKeys[3]),
        ];
        const specialistResults = await Promise.all(specialistPromises);
        const analyses1_4 = specialistResults.map(res => res.candidates[0].content.parts[0].text);

        const synthesizerPrompts = getSynthesizerPrompts(historySnippet, analyses1_4);
        const synthesizerPromises = [
            callGemini(synthesizerPrompts.ai5.system, synthesizerPrompts.ai5.user, state.apiKeys[4]),
            callGemini(synthesizerPrompts.ai6.system, synthesizerPrompts.ai6.user, state.apiKeys[5]),
        ];
        const synthesizerResults = await Promise.all(synthesizerPromises);
        const analyses5_6 = synthesizerResults.map(res => res.candidates[0].content.parts[0].text);

        const contrarianPrompts = getContrarianPrompts(historySnippet, analyses5_6);
        const contrarianPromises = [
             callGemini(contrarianPrompts.ai7.system, contrarianPrompts.ai7.user, state.apiKeys[6]),
             callGemini(contrarianPrompts.ai8.system, contrarianPrompts.ai8.user, state.apiKeys[7]),
        ];
        const contrarianResults = await Promise.all(contrarianPromises);
        const analyses7_8 = contrarianResults.map(res => res.candidates[0].content.parts[0].text);
        
        const viceChairPrompt = getViceChairPrompt(historySnippet, analyses5_6, analyses7_8);
        const viceChairResult = await callGemini(viceChairPrompt.system, viceChairPrompt.user, state.apiKeys[8]);
        const analysis9 = viceChairResult.candidates[0].content.parts[0].text;
        
        const chairmanPrompt = getChairmanPrompt(historySnippet, analysis9);
        const chairmanResult = await callGemini(chairmanPrompt.system, chairmanPrompt.user, state.apiKeys[9]);
        const finalDecision = JSON.parse(chairmanResult.candidates[0].content.parts[0].text);
        
        state.lastPrediction = {
            prediction: finalDecision.prediction,
            reasoning: finalDecision.reasoning
        };
        
        updateAnalysisUI(renderSinglePrediction(state.lastPrediction));

    } catch (error) {
        console.error("AI Analysis Error:", error);
        updateAnalysisUI(`<div class="text-center text-red-400"><p class="font-semibold">L·ªói ph√¢n t√≠ch!</p><p class="text-sm mt-2">${error.message}.</p></div>`);
        state.lastPrediction = null;
    } finally {
        state.isAnalyzing = false;
        saveState();
    }
}

function getSpecialistPrompts(historySnippet) {
    const baseSystem = `You are a Baccarat analyst. Predict the NEXT outcome (P or B). Return ONLY a single-line JSON object: {"prediction": "P" or "B", "reasoning": "Your brief reason in Vietnamese"}.`;
    return {
        ai1: { system: baseSystem, user: `History: ${historySnippet}\nFocus ONLY on long streaks (b·ªát) and 1-1 patterns.` },
        ai2: { system: baseSystem, user: `History: ${historySnippet}\nFocus ONLY on short, repeating sequences (3-5 hands).` },
        ai3: { system: baseSystem, user: `History: ${historySnippet}\nFocus ONLY on statistical imbalances.` },
        ai4: { system: baseSystem, user: `History: ${historySnippet}\nFocus ONLY on when streaks are likely to break based on historical maximums.` }
    };
}
function getSynthesizerPrompts(historySnippet, specialistResults) {
    const baseSystem = `You are a Baccarat analyst. Combine two analyses into a single, stronger prediction. Return ONLY a single-line JSON object: {"prediction": "P" or "B", "reasoning": "Your combined reason in Vietnamese"}.`;
    return {
        ai5: { system: baseSystem, user: `History: ${historySnippet}\nCombine:\n1. Streak: ${specialistResults[0]}\n2. Sequence: ${specialistResults[1]}` },
        ai6: { system: baseSystem, user: `History: ${historySnippet}\nCombine:\n1. Statistical: ${specialistResults[2]}\n2. Streak Breaking: ${specialistResults[3]}` },
    };
}
function getContrarianPrompts(historySnippet, synthesizerResults) {
    const baseSystem = `You are a contrarian Baccarat analyst. Find weaknesses in an analysis. Return ONLY a single-line JSON object: {"prediction": "P" or "B", "reasoning": "Your brief reason for the opposite bet in Vietnamese"}.`;
    return {
        ai7: { system: baseSystem, user: `History: ${historySnippet}\nAnalysis: ${synthesizerResults[0]}\nFind a reason to bet AGAINST this.` },
        ai8: { system: baseSystem, user: `History: ${historySnippet}\nAnalysis: ${synthesizerResults[1]}\nFind a reason to bet AGAINST this.` },
    }
}
function getViceChairPrompt(historySnippet, synthesizerResults, contrarianResults) {
    const system = `You are a Vice-Chair. Summarize arguments and counter-arguments into a final recommendation. Return a single JSON object.`;
    const user = `History: ${historySnippet}\n- Argument A: ${synthesizerResults[0]}\n- Counter-Argument A: ${contrarianResults[0]}\n- Argument B: ${synthesizerResults[1]}\n- Counter-Argument B: ${contrarianResults[1]}\n\nSummarize and provide your final recommendation: {"prediction": "P" or "B", "reasoning": "Your summary and recommendation in Vietnamese"}.`;
    return { system, user };
}
function getChairmanPrompt(historySnippet, viceChairResult) {
    const system = `You are the Chairman. You make the final, decisive prediction. Return ONLY a single-line JSON object: {"prediction": "P" or "B", "reasoning": "Your final, decisive reason in Vietnamese"}.`;
    const user = `History: ${historySnippet}\nYour Vice-Chair has summarized: ${viceChairResult}\nMake the FINAL prediction.`;
    return { system, user };
}
async function callGemini(systemPrompt, userQuery, apiKey) {
    const apiUrl = `${GEMINI_API_URL}${apiKey}`;
    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        generationConfig: { responseMimeType: "application/json", temperature: 0.4 },
    };
    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    if (!response.ok) {
        const error = await response.json();
        throw new Error(`L·ªói API: ${error.error.message}`);
    }
    return response.json();
}

function renderSinglePrediction(data) {
    const { prediction, reasoning } = data;
    const color = prediction === 'P' ? 'blue' : 'red';
    const glowClass = prediction === 'P' ? 'card-glow-p' : 'card-glow-b';
    const analysisCard = document.getElementById('analysis-card');
    analysisCard.classList.add(glowClass);

    return `
        <div class="bg-gray-700/50 p-4 rounded-lg mb-4">
            <h4 class="font-semibold text-gray-200 mb-2">L√Ω Do ƒê·ªÅ Xu·∫•t:</h4>
            <p class="text-gray-300 text-sm leading-relaxed">${reasoning}</p>
        </div>
        <div class="text-center bg-gray-900/70 py-4 rounded-lg border-2 border-${color}-500">
            <p class="text-lg text-gray-400">H·ªôi ƒê·ªìng AI ƒê·ªÅ xu·∫•t:</p>
            <p class="text-4xl font-bold text-${color}-400 my-1">${prediction === 'P' ? 'CON' : 'C√ÅI'}</p>
            <p class="text-xs text-yellow-400 mt-1 animate-pulse">Ch·ªù k·∫øt qu·∫£ v√°n ti·∫øp theo...</p>
        </div>
    `;
}

function updateAnalysisUI(content) {
    const analysisResultDiv = document.getElementById('analysisResult');
    const analysisCard = document.getElementById('analysis-card');
    analysisCard.classList.remove('card-glow-p', 'card-glow-b', 'card-glow-wait');
    analysisResultDiv.innerHTML = content;
}

// --- INITIALIZATION ---
function initializeAppUI() {
    updateAnalysisUI(`<p class="text-gray-400 text-center">Nh·∫≠p ƒë·ªß 10 API Keys v√† c√≥ √≠t nh·∫•t ${MIN_HISTORY_FOR_ANALYSIS} v√°n c∆∞·ª£c ƒë·ªÉ H·ªôi ƒë·ªìng b·∫Øt ƒë·∫ßu l√†m vi·ªác.</p>`);
}

function initializeApp() {
    loadState();
    document.getElementById('totalGames').textContent = state.history.length;
    renderAllRoads();
    renderStatsAndChart();
    initializeAppUI();
}
document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>

