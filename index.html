<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ph√¢n T√≠ch Baccarat T·ªïng H·ª£p</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c101b;
            color: #F9FAFB;
        }
        .btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn:active:not(:disabled) { transform: translateY(1px); }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }

        .card-glow-p { box-shadow: 0 0 25px rgba(59, 130, 246, 0.6); }
        .card-glow-b { box-shadow: 0 0 25px rgba(239, 68, 68, 0.6); }
        .card-glow-certain { box-shadow: 0 0 30px rgba(250, 204, 21, 0.7); }

        .road-grid {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: 24px;
            gap: 2px;
            overflow-x: auto;
            padding: 8px;
            min-height: 160px;
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        .road-col { display: grid; grid-auto-rows: 24px; gap: 2px; }
        .road-item {
            width: 24px; height: 24px; display: flex;
            align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8rem; color: white; position: relative;
        }
        .road-item-big { border-radius: 9999px; border: 2px solid; }
        .road-item-p { border-color: #3b82f6; color: #3b82f6; }
        .road-item-b { border-color: #ef4444; color: #ef4444; }
        .road-item-t { background-color: #10b981; border-radius: 9999px; }
        .tie-slash { position: absolute; width: 100%; height: 2px; background-color: #10b981; transform: rotate(-45deg); }
        .pair-dot { position: absolute; width: 6px; height: 6px; border-radius: 50%; }
        .pair-dot.p-pair { background-color: #3b82f6; top: 2px; right: 2px; }
        .pair-dot.b-pair { background-color: #ef4444; bottom: 2px; left: 2px; }
        .bead-plate-item-p { background-color: #3b82f6; border-radius: 9999px;}
        .bead-plate-item-b { background-color: #ef4444; border-radius: 9999px;}
        
        .derived-item { width: 10px; height: 10px; border-radius: 9999px; }
        .big-eye-boy-p { border: 2px solid #ef4444; }
        .big-eye-boy-b { border: 2px solid #3b82f6; }
        .small-road-p { background-color: #ef4444; }
        .small-road-b { background-color: #3b82f6; }
        .cockroach-pig-p { border: 1px solid #ef4444; background: linear-gradient(to top right, transparent calc(50% - 0.5px), #ef4444, transparent calc(50% + 0.5px)); }
        .cockroach-pig-b { border: 1px solid #3b82f6; background: linear-gradient(to top right, transparent calc(50% - 0.5px), #3b82f6, transparent calc(50% + 0.5px)); }
        
        .pair-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        
        /* Modal and Toast styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            z-index: 50; animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: #1f2937; padding: 1.5rem; border-radius: 1rem;
            width: 90%; max-width: 450px; animation: slideIn 0.3s ease-out;
            border: 1px solid #374151;
        }
        .toast-notification {
            position: fixed; top: 20px; right: 20px;
            background-color: #1f2937; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); z-index: 100; animation: slideDown 0.5s ease;
            border-left: 4px solid;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-100%); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-8">

<div id="modal-container"></div>
<div id="toast-container"></div>

<div class="max-w-screen-xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 lg:items-start">

    <!-- Left Column: Input & History -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Header -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg text-center">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-purple-400 to-red-400">H·ªá Th·ªëng Ph√¢n T√≠ch Baccarat T·ªïng H·ª£p</h1>
            <p class="text-gray-400 mt-2">AI Synthesis Engine v1.0</p>
        </div>
        
        <!-- Controls -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold text-blue-300">‚öôÔ∏è B·∫£ng ƒêi·ªÅu Khi·ªÉn</h2>
                 <div class="flex items-center gap-4">
                    <button onclick="openSettingsModal()" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-key fa-lg"></i></button>
                    <button onclick="openHelpModal()" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-question-circle fa-lg"></i></button>
                </div>
             </div>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <button id="btnP" onclick="addResult('P')" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-6 rounded-lg text-2xl"><span>üë§</span> CON</button>
                <button id="btnT" onclick="addResult('T')" class="btn bg-green-600 hover:bg-green-500 text-white font-bold py-6 rounded-lg text-2xl"><span>ü§ù</span> H√íA</button>
                <button id="btnB" onclick="addResult('B')" class="btn bg-red-600 hover:bg-red-500 text-white font-bold py-6 rounded-lg text-2xl"><span>üè¶</span> C√ÅI</button>
            </div>

            <div class="flex items-center justify-center gap-6 mb-4 text-white">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="playerPair" class="w-5 h-5 rounded border-2 border-blue-400 text-blue-500 focus:ring-blue-500 pair-checkbox appearance-none">
                    <span>Con ƒê√¥i</span>
                </label>
                 <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="bankerPair" class="w-5 h-5 rounded border-2 border-red-400 text-red-500 focus:ring-red-500 pair-checkbox appearance-none">
                    <span>C√°i ƒê√¥i</span>
                </label>
            </div>

            <div class="flex gap-4">
                <button onclick="undoLast()" class="btn flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">‚Ü©Ô∏è Ho√†n T√°c</button>
                <button onclick="showCustomConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠ c·ªßa PHI√äN N√ÄY kh√¥ng? D·ªØ li·ªáu c√°c phi√™n c≈© v·∫´n ƒë∆∞·ª£c gi·ªØ l·∫°i.', clearCurrentSessionHistory)" class="btn flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg">üóëÔ∏è X√≥a Phi√™n</button>
            </div>
        </div>

        <!-- History Display -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-semibold text-blue-300">üìú C√°c B·∫£ng C·∫ßu</h2>
                    <span class="text-gray-400 font-medium text-sm">T·ªïng: <span id="totalGames">0</span> v√°n</span>
                </div>
                <div id="statsContainer" class="text-right text-xs space-y-1 text-gray-300 bg-gray-900/50 p-2 rounded-md"></div>
            </div>

            <div class="grid grid-cols-12 gap-2">
                <!-- Main Roads -->
                <div class="col-span-12 md:col-span-8 space-y-2">
                    <div class="bg-gray-900 rounded-lg border border-gray-700"><div id="beadPlateDisplay" class="road-grid"></div></div>
                    <div class="bg-gray-900 rounded-lg border border-gray-700"><div id="bigRoadDisplay" class="road-grid"></div></div>
                </div>
                <!-- Derived Roads -->
                <div class="col-span-12 md:col-span-4 space-y-2">
                    <div class="bg-gray-900 rounded-lg border border-gray-700 grid grid-cols-2">
                        <div id="bigEyeBoyDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1"></div>
                        <div id="pAskDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1 border-l-2 border-gray-700"></div>
                    </div>
                     <div class="bg-gray-900 rounded-lg border border-gray-700 grid grid-cols-2">
                        <div id="smallRoadDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1"></div>
                        <div id="bAskDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1 border-l-2 border-gray-700"></div>
                    </div>
                     <div class="bg-gray-900 rounded-lg border border-gray-700"><div id="cockroachPigDisplay" class="road-grid !grid-auto-columns-[10px] !grid-auto-rows-[10px] !min-h-[80px] !p-1"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Analysis & Stats -->
    <div class="space-y-6 lg:sticky lg:top-6">
        <div id="analysis-card" class="bg-gray-800 p-6 rounded-2xl shadow-lg transition-shadow duration-500">
            <h2 class="text-xl font-semibold mb-4 text-yellow-300 flex items-center gap-2">
                <i class="fa-solid fa-brain"></i> Ph√¢n T√≠ch T·ªïng H·ª£p
            </h2>
            <div id="analysisResult" class="space-y-4 min-h-[250px] flex flex-col justify-center">
                <!-- AI content goes here -->
            </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-cyan-300">üåê Qu·∫£n L√Ω D·ªØ Li·ªáu L·ªãch S·ª≠</h2>
             <div class="flex flex-col sm:flex-row gap-4 mb-4">
                 <select id="sessionSelector" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none"></select>
                 <div class="grid grid-cols-3 gap-2">
                     <button onclick="createNewSession()" class="btn w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-3 rounded-lg text-sm">‚ûï M·ªõi</button>
                     <button onclick="renameSession()" class="btn w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-3 rounded-lg text-sm">‚úèÔ∏è S·ª≠a</button>
                     <button onclick="deleteSelectedSession()" class="btn w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-3 rounded-lg text-sm">üóëÔ∏è X√≥a</button>
                 </div>
             </div>
             <div class="flex flex-col sm:flex-row gap-4">
                 <button onclick="exportData()" class="btn w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-lg">üì§ Xu·∫•t To√†n B·ªô</button>
                 <button onclick="document.getElementById('fileInput').click()" class="btn w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg">üì• Nh·∫≠p D·ªØ Li·ªáu</button>
                 <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importData(event)">
             </div>
        </div>

    </div>
</div>


<script>
// --- GLOBAL STATE & CONFIG ---
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
const MIN_HISTORY_FOR_ANALYSIS = 10;
let state = {
    currentSessionId: null,
    sessions: {},
    apiKey: '',
    isAnalyzing: false,
    lastPrediction: null,
};

// --- ROADMAP LOGIC ---
class BaccaratRoadmapGenerator {
    // This class remains unchanged from the previous version.
    // It correctly generates all roadmaps needed for visual analysis.
    generateBigRoad(history) {
        const columns = []; if (history.length === 0) return columns;
        let currentCol = []; let lastWinner = null;
        history.forEach(item => {
            if (item.winner === 'T') {
                if (currentCol.length > 0) { currentCol[currentCol.length - 1].ties = (currentCol[currentCol.length - 1].ties || 0) + 1; } 
                else if (columns.length > 0) { const prevCol = columns[columns.length - 1]; prevCol[prevCol.length - 1].ties = (prevCol[prevCol.length - 1].ties || 0) + 1; }
            } else {
                const bead = { winner: item.winner, pPair: item.pPair, bPair: item.bPair, ties: 0 };
                if (item.winner === lastWinner) { currentCol.push(bead); } 
                else { if (currentCol.length > 0) columns.push(currentCol); currentCol = [bead]; lastWinner = item.winner; }
            }
        });
        if (currentCol.length > 0) columns.push(currentCol); return columns;
    }
    generateDerivedRoads(bigRoad, hypotheticalWinner = null) {
        let tempBigRoad = JSON.parse(JSON.stringify(bigRoad));
        if (hypotheticalWinner) {
            const lastCol = tempBigRoad[tempBigRoad.length - 1];
            if (lastCol && lastCol[0].winner === hypotheticalWinner) { lastCol.push({ winner: hypotheticalWinner }); } 
            else { tempBigRoad.push([{ winner: hypotheticalWinner }]); }
        }
        const results = { bigEyeBoy: [], smallRoad: [], cockroachPig: [] };
        for (let i = 0; i < tempBigRoad.length; i++) {
            for (let j = 0; j < tempBigRoad[i].length; j++) {
                if ((i === 1 && j === 1) || i > 1) this.addDerivedResult(results.bigEyeBoy, tempBigRoad, i, j, 1);
                if ((i === 2 && j === 1) || i > 2) this.addDerivedResult(results.smallRoad, tempBigRoad, i, j, 2);
                if ((i === 3 && j === 1) || i > 3) this.addDerivedResult(results.cockroachPig, tempBigRoad, i, j, 3);
            }
        }
        return results;
    }
    addDerivedResult(road, bigRoad, i, j, offset) { const result = this.compare(bigRoad, i, j, offset); if (result) road.push(result); }
    compare(bigRoad, i, j, offset) {
        let isPattern;
        if (j === 0) {
            const prevCol = bigRoad[i - 1]; const refCol = bigRoad[i - 1 - offset]; if (!prevCol || !refCol) return null;
            isPattern = prevCol.length === refCol.length;
        } else {
            const refCol = bigRoad[i - offset]; if (!refCol) return null;
            const hasBeadAtDepth = !!refCol[j]; const hasBeadAtPrevDepth = !!refCol[j - 1];
            isPattern = hasBeadAtDepth === hasBeadAtPrevDepth;
        }
        return { winner: isPattern ? 'P' : 'B' };
    }
}
const roadmapGenerator = new BaccaratRoadmapGenerator();

// --- STATISTICAL PATTERN MATCHER LOGIC ---
class PatternMatcher {
    // This class is adapted from the second system.
    // It performs historical data matching.
    constructor() {
        this.MIN_PATTERN_LENGTH = 10;
        this.MAX_PATTERN_LENGTH = 15;
        this.MIN_CERTAIN_OCCURRENCES = 5;
    }
    findPatternOccurrences(pattern, allHistory) {
        const occurrences = [];
        const patternStr = pattern.join('');
        for (const session of allHistory) {
            const sessionHistory = (session.history || []).map(h => h.winner);
            if (sessionHistory.length < pattern.length + 1) continue;
            for (let i = 0; i <= sessionHistory.length - pattern.length - 1; i++) {
                const segment = sessionHistory.slice(i, i + pattern.length);
                if (segment.join('') === patternStr) {
                     occurrences.push(sessionHistory[i + pattern.length]);
                }
            }
        }
        return occurrences;
    }
    getPrediction(currentHistory, allHistoricalSessions) {
        const history = currentHistory.map(h => h.winner);
        if (history.length < this.MIN_PATTERN_LENGTH) {
            return { recommendation: "NOT_ENOUGH_DATA" };
        }
        for (let len = Math.min(this.MAX_PATTERN_LENGTH, history.length); len >= this.MIN_PATTERN_LENGTH; len--) {
            const pattern = history.slice(-len);
            const occurrences = this.findPatternOccurrences(pattern, allHistoricalSessions);
            if (occurrences.length > 0) {
                const votes = { P: 0, B: 0 };
                occurrences.forEach(next => { if(votes[next] !== undefined) votes[next]++; });
                
                // Check for "Certain" prediction
                if (occurrences.length >= this.MIN_CERTAIN_OCCURRENCES && new Set(occurrences).size === 1) {
                    return {
                        isCertain: true,
                        prediction: occurrences[0],
                        patternLength: len,
                        occurrences: occurrences.length,
                        reasoning: `T√¨m th·∫•y ${occurrences.length} l·∫ßn xu·∫•t hi·ªán CH√çNH X√ÅC c·ªßa h√¨nh c·∫ßu n√†y trong l·ªãch s·ª≠. T·∫•t c·∫£ ƒë·ªÅu cho k·∫øt qu·∫£ ti·∫øp theo l√†: ${occurrences[0]}.`
                    };
                }

                // Standard prediction
                if (votes.P + votes.B > 0) {
                     const prediction = votes.P > votes.B ? 'P' : 'B';
                     const confidence = (Math.max(votes.P, votes.B) / (votes.P + votes.B)) * 100;
                     return {
                         isCertain: false,
                         prediction,
                         confidence: confidence.toFixed(1),
                         patternLength: len,
                         occurrences: occurrences.length,
                         votes,
                         reasoning: `T√¨m th·∫•y ${occurrences.length} l·∫ßn xu·∫•t hi·ªán c·ªßa h√¨nh c·∫ßu t∆∞∆°ng t·ª± (${len} v√°n). K·∫øt qu·∫£ trong qu√° kh·ª©: ${votes.P} l·∫ßn Con, ${votes.B} l·∫ßn C√°i.`
                     };
                }
            }
        }
        return { recommendation: "NO_PATTERN_FOUND" };
    }
}
const patternMatcher = new PatternMatcher();


// --- UI RENDERING ---
function renderAllRoads() {
    if (!state.currentSessionId) return;
    const history = state.sessions[state.currentSessionId]?.history || [];
    const bigRoad = roadmapGenerator.generateBigRoad(history);
    renderBeadPlateUI(history);
    renderBigRoadUI(bigRoad);
    const derivedRoads = roadmapGenerator.generateDerivedRoads(bigRoad);
    renderDerivedRoadUI('bigEyeBoyDisplay', derivedRoads.bigEyeBoy, 'big-eye-boy');
    renderDerivedRoadUI('smallRoadDisplay', derivedRoads.smallRoad, 'small-road');
    renderDerivedRoadUI('cockroachPigDisplay', derivedRoads.cockroachPig, 'cockroach-pig');
    updatePredictionProbes(bigRoad);
    updateStatsUI(history);
}
// Other rendering functions (renderBeadPlateUI, renderBigRoadUI, etc.) are identical
// to the first system and are kept for visual display.
function renderBeadPlateUI(data) {
    const container = document.getElementById('beadPlateDisplay'); container.innerHTML = '';
    const maxRows = 6; let currentCol = document.createElement('div'); currentCol.className = 'road-col';
    data.forEach((item, index) => {
        if (index > 0 && index % maxRows === 0) { container.appendChild(currentCol); currentCol = document.createElement('div'); currentCol.className = 'road-col'; }
        const itemDiv = document.createElement('div');
        const colorClass = item.winner === 'P' ? 'bead-plate-item-p' : item.winner === 'B' ? 'bead-plate-item-b' : 'road-item-t';
        itemDiv.className = `road-item ${colorClass}`; itemDiv.textContent = item.winner;
        if (item.pPair) itemDiv.innerHTML += '<div class="pair-dot p-pair"></div>'; if (item.bPair) itemDiv.innerHTML += '<div class="pair-dot b-pair"></div>';
        currentCol.appendChild(itemDiv);
    });
    if (currentCol.hasChildNodes()) container.appendChild(currentCol); container.scrollLeft = container.scrollWidth;
}
function renderBigRoadUI(columns) {
    const container = document.getElementById('bigRoadDisplay'); container.innerHTML = '';
    columns.forEach(colData => {
        const colDiv = document.createElement('div'); colDiv.className = 'road-col';
        colData.forEach(item => {
            const itemDiv = document.createElement('div'); itemDiv.className = `road-item road-item-big road-item-${item.winner.toLowerCase()}`;
            if (item.pPair) itemDiv.innerHTML += '<div class="pair-dot p-pair"></div>'; if (item.bPair) itemDiv.innerHTML += '<div class="pair-dot b-pair"></div>';
            if (item.ties > 0) { itemDiv.innerHTML += `<div class="tie-slash"></div>`; if(item.ties > 1) itemDiv.innerHTML += `<span class="absolute text-xs font-bold text-white">${item.ties}</span>`; }
            colDiv.appendChild(itemDiv);
        });
        container.appendChild(colDiv);
    });
    container.scrollLeft = container.scrollWidth;
}
function renderDerivedRoadUI(containerId, data, type) {
    const container = document.getElementById(containerId); container.innerHTML = ''; if (data.length === 0) return;
    const columns = roadmapGenerator.generateBigRoad(data);
    columns.forEach(colData => {
        const colDiv = document.createElement('div'); colDiv.className = 'road-col !grid-auto-rows-[10px]';
        colData.forEach(item => {
            const itemDiv = document.createElement('div'); const color = item.winner === 'P' ? 'p' : 'b';
            itemDiv.className = `derived-item ${type}-${color}`; colDiv.appendChild(itemDiv);
        });
        container.appendChild(colDiv);
    });
    container.scrollLeft = container.scrollWidth;
}
function updatePredictionProbes(bigRoad) {
    const pAskContainer = document.getElementById('pAskDisplay'); const bAskContainer = document.getElementById('bAskDisplay');
    pAskContainer.innerHTML = ''; bAskContainer.innerHTML = '';
    const pProbeRoads = roadmapGenerator.generateDerivedRoads(bigRoad, 'P');
    const pBigEyeNext = pProbeRoads.bigEyeBoy.pop(); const pSmallNext = pProbeRoads.smallRoad.pop(); const pCockroachNext = pProbeRoads.cockroachPig.pop();
    let pAskHTML = '<div class="road-col !grid-auto-rows-[10px]">';
    if (pBigEyeNext) pAskHTML += `<div class="derived-item big-eye-boy-${pBigEyeNext.winner.toLowerCase()}"></div>`;
    if (pSmallNext) pAskHTML += `<div class="derived-item small-road-${pSmallNext.winner.toLowerCase()}"></div>`;
    if (pCockroachNext) pAskHTML += `<div class="derived-item cockroach-pig-${pCockroachNext.winner.toLowerCase()}"></div>`;
    pAskContainer.innerHTML = pAskHTML + '</div>';
    const bProbeRoads = roadmapGenerator.generateDerivedRoads(bigRoad, 'B');
    const bBigEyeNext = bProbeRoads.bigEyeBoy.pop(); const bSmallNext = bProbeRoads.smallRoad.pop(); const bCockroachNext = bProbeRoads.cockroachPig.pop();
    let bAskHTML = '<div class="road-col !grid-auto-rows-[10px]">';
    if (bBigEyeNext) bAskHTML += `<div class="derived-item big-eye-boy-${bBigEyeNext.winner.toLowerCase()}"></div>`;
    if (bSmallNext) bAskHTML += `<div class="derived-item small-road-${bSmallNext.winner.toLowerCase()}"></div>`;
    if (bCockroachNext) bAskHTML += `<div class="derived-item cockroach-pig-${bCockroachNext.winner.toLowerCase()}"></div>`;
    bAskContainer.innerHTML = bAskHTML + '</div>';
}
function updateStatsUI(history) {
    const stats = { P: 0, B: 0, T: 0, pPair: 0, bPair: 0 };
    history.forEach(h => { stats[h.winner] = (stats[h.winner] || 0) + 1; if(h.pPair) stats.pPair++; if(h.bPair) stats.bPair++; });
    document.getElementById('statsContainer').innerHTML = `<div>C: ${stats.P}</div><div>B: ${stats.B}</div><div>T: ${stats.T}</div><div>Cƒê: ${stats.pPair}</div><div>Bƒê: ${stats.bPair}</div>`;
}
function updateAnalysisUI(content) {
    const analysisResultDiv = document.getElementById('analysisResult');
    const analysisCard = document.getElementById('analysis-card');
    analysisCard.classList.remove('card-glow-p', 'card-glow-b', 'card-glow-certain');
    analysisResultDiv.innerHTML = content;
}


// --- CORE ACTIONS ---
function addResult(winner) {
    if (state.isAnalyzing) return;
    const pPair = document.getElementById('playerPair').checked;
    const bPair = document.getElementById('bankerPair').checked;

    const session = state.sessions[state.currentSessionId];
    if (state.lastPrediction && winner !== 'T') {
        if (!session.predictions) session.predictions = [];
        const outcome = state.lastPrediction.prediction === winner ? 'win' : 'loss';
        session.predictions.push({ ...state.lastPrediction, actual: winner, outcome });
    }
    
    state.lastPrediction = null;
    session.history.push({ winner, pPair, bPair });
    
    document.getElementById('totalGames').textContent = session.history.length;
    document.getElementById('playerPair').checked = false;
    document.getElementById('bankerPair').checked = false;

    renderAllRoads();
    saveState();
    triggerCombinedAnalysis();
}

function undoLast() {
    if (state.isAnalyzing) return;
    const session = state.sessions[state.currentSessionId];
    if (session.history.length === 0) return;

    session.history.pop();
    if(state.lastPrediction) {
       // If we undo a hand that had a pending prediction, we just clear the prediction
       state.lastPrediction = null;
    } else if (session.predictions && session.predictions.length > 0) {
        // If we undo a hand that ALREADY had a result, we pop the prediction record
        session.predictions.pop();
    }
    
    document.getElementById('totalGames').textContent = session.history.length;
    renderAllRoads();
    saveState();
    triggerCombinedAnalysis(); // Re-analyze with the previous state
}

function clearCurrentSessionHistory() {
    const session = state.sessions[state.currentSessionId];
    session.history = [];
    session.predictions = [];
    state.lastPrediction = null;
    document.getElementById('totalGames').textContent = 0;
    renderAllRoads();
    saveState();
    updateAnalysisUI(`<p class="text-gray-400 text-center">ƒê√£ x√≥a l·ªãch s·ª≠ phi√™n. S·∫µn s√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.</p>`);
}


// --- AI ANALYSIS & PROMPT ENGINEERING ---
async function triggerCombinedAnalysis() {
    if (state.isAnalyzing) return;
    const session = state.sessions[state.currentSessionId];
    if (!state.apiKey) {
        updateAnalysisUI(`<div class="text-center"><p class="text-yellow-400 font-semibold">Vui l√≤ng nh·∫≠p Gemini API Key!</p><p class="text-gray-400 mt-2 text-sm">Click icon <i class="fas fa-key"></i> ƒë·ªÉ c√†i ƒë·∫∑t.</p></div>`);
        return;
    }
    if (session.history.length < MIN_HISTORY_FOR_ANALYSIS) {
        updateAnalysisUI(`<p class="text-gray-400 text-center">C·∫ßn √≠t nh·∫•t ${MIN_HISTORY_FOR_ANALYSIS} v√°n ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch...</p>`);
        return;
    }

    state.isAnalyzing = true;
    updateAnalysisUI(`<div class="flex flex-col items-center justify-center h-full"><div class="w-8 h-8 border-4 border-t-blue-500 border-gray-600 rounded-full animate-spin"></div><p class="text-gray-400 mt-3 animate-pulse">AI ƒëang t·ªïng h·ª£p d·ªØ li·ªáu...</p></div>`);
    
    try {
        const prompt = createRichPrompt();
        const response = await fetch(`${GEMINI_API_URL}${state.apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{text: "You are an elite Baccarat analyst. You synthesize visual roadmap data and historical statistical data to make the best prediction. Your response MUST be a single JSON object containing: 'prediction' ('P' or 'B'), 'confidence' (a number 1-10), and 'reasoning' (a concise, expert analysis in Vietnamese, max 3 sentences)."}] }
            })
        });

        if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error("No content in API response.");
        
        const responseData = JSON.parse(text.replace(/```json|```/g, ''));
        
        // Combine AI result with statistical result for display
        const statisticalAnalysis = patternMatcher.getPrediction(session.history, Object.values(state.sessions));
        state.lastPrediction = { ...responseData, statisticalAnalysis }; // Store the full context
        
        updateAnalysisUI(renderCombinedPrediction(state.lastPrediction));

    } catch (error) {
        console.error("AI Analysis Error:", error);
        updateAnalysisUI(`<div class="text-center text-red-400"><p class="font-semibold">L·ªói ph√¢n t√≠ch!</p><p class="text-sm mt-2">${error.message}.</p></div>`);
        state.lastPrediction = null;
    } finally {
        state.isAnalyzing = false;
        const controlBtns = document.querySelectorAll('#btnP, #btnT, #btnB');
        controlBtns.forEach(btn => btn.disabled = false);
        saveState();
    }
}

function createRichPrompt() {
    const session = state.sessions[state.currentSessionId];
    const history = session.history;
    const historyString = history.map(h => h.winner).join(', ');
    const bigRoad = roadmapGenerator.generateBigRoad(history);
    const derivedRoads = roadmapGenerator.generateDerivedRoads(bigRoad);

    const promptData = {
        visual_analysis: {
            history_sequence: historyString,
            big_road: bigRoad.map(col => col.map(c => c.winner).join('')).join(' | '),
            big_eye_boy: derivedRoads.bigEyeBoy.map(i => i.winner).join('').replace(/P/g, 'R').replace(/B/g, 'B'),
            small_road: derivedRoads.smallRoad.map(i => i.winner).join('').replace(/P/g, 'R').replace(/B/g, 'B'),
            cockroach_pig: derivedRoads.cockroachPig.map(i => i.winner).join('').replace(/P/g, 'R').replace(/B/g, 'B')
        },
        statistical_analysis: patternMatcher.getPrediction(history, Object.values(state.sessions))
    };

    return JSON.stringify(promptData);
}

function renderCombinedPrediction(data) {
    const { prediction, confidence, reasoning, statisticalAnalysis } = data;
    const color = prediction === 'P' ? 'blue' : 'red';
    const glowClass = prediction === 'P' ? 'card-glow-p' : 'card-glow-b';
    const analysisCard = document.getElementById('analysis-card');
    analysisCard.classList.add(glowClass);

    let statsHTML = '';
    if (statisticalAnalysis.isCertain) {
        statsHTML = `<div class="bg-yellow-800/30 p-3 rounded-lg border border-yellow-500">
            <h4 class="font-semibold text-yellow-300 mb-1 text-sm">Ph√¢n T√≠ch L·ªãch S·ª≠ (TAY CH·∫ÆC CH·∫ÆN)</h4>
            <p class="text-gray-300 text-xs leading-relaxed">${statisticalAnalysis.reasoning}</p>
        </div>`;
        analysisCard.classList.remove('card-glow-p', 'card-glow-b');
        analysisCard.classList.add('card-glow-certain');
    } else if (statisticalAnalysis.prediction) {
         statsHTML = `<div class="bg-gray-700/50 p-3 rounded-lg">
            <h4 class="font-semibold text-gray-200 mb-1 text-sm">Ph√¢n T√≠ch L·ªãch S·ª≠ (Th·ªëng k√™)</h4>
            <p class="text-gray-300 text-xs leading-relaxed">${statisticalAnalysis.reasoning}</p>
        </div>`;
    }

    const confidenceMeter = `
        <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
            <div class="bg-gradient-to-r from-${color}-500 to-${color}-400 h-2.5 rounded-full" style="width: ${confidence * 10}%"></div>
        </div>
    `;

    return `
        <div class="text-center bg-gray-900/70 py-4 rounded-lg border-2 border-${color}-500">
            <p class="text-lg text-gray-400">AI ƒê·ªÅ xu·∫•t:</p>
            <p class="text-5xl font-bold text-${color}-400 my-1">${prediction === 'P' ? 'CON' : 'C√ÅI'}</p>
            <p class="text-sm text-gray-300">ƒê·ªô tin c·∫≠y: ${confidence}/10</p>
            ${confidenceMeter}
        </div>

        <div class="bg-gray-700/50 p-3 rounded-lg mt-3">
             <h4 class="font-semibold text-gray-200 mb-1 text-sm">L√Ω Do c·ªßa AI:</h4>
             <p class="text-gray-300 text-xs leading-relaxed">${reasoning}</p>
        </div>
        
        ${statsHTML}

        <p class="text-xs text-yellow-400 text-center mt-3 animate-pulse">Ch·ªù k·∫øt qu·∫£ v√°n ti·∫øp theo...</p>
    `;
}


// --- SESSION MANAGEMENT ---
function getSessions() { try { return JSON.parse(localStorage.getItem('baccaratCombinedSessions_v1')) || {}; } catch (e) { return {}; }}
function saveState() {
    localStorage.setItem('baccaratCombinedSessions_v1', JSON.stringify(state.sessions));
    localStorage.setItem('baccaratCombined_apiKey_v1', state.apiKey);
    localStorage.setItem('baccaratCombined_lastSession_v1', state.currentSessionId);
}
function loadState() {
    state.sessions = getSessions();
    state.apiKey = localStorage.getItem('baccaratCombined_apiKey_v1') || '';
    const lastSessionId = localStorage.getItem('baccaratCombined_lastSession_v1');
    
    if (Object.keys(state.sessions).length === 0) {
        createNewSession();
    } else {
        const idToLoad = (lastSessionId && state.sessions[lastSessionId]) ? lastSessionId : Object.keys(state.sessions)[0];
        loadSession(idToLoad);
    }
}
function updateSessionSelector() {
    const selector = document.getElementById('sessionSelector');
    selector.innerHTML = '';
    const sortedKeys = Object.keys(state.sessions).sort((a, b) => parseInt(b.split('-')[1]) - parseInt(a.split('-')[1]));
    sortedKeys.forEach(sessionId => {
        const option = document.createElement('option');
        option.value = sessionId;
        option.textContent = `${state.sessions[sessionId].name} (${state.sessions[sessionId].history.length} v√°n)`;
        selector.appendChild(option);
    });
    selector.value = state.currentSessionId;
    selector.onchange = () => loadSession(selector.value);
}
function createNewSession() {
    const newId = `session-${Date.now()}`;
    state.sessions[newId] = { name: `Phi√™n ${new Date().toLocaleString('vi-VN')}`, history: [], predictions: [] };
    loadSession(newId);
}
function renameSession() {
    if (!state.currentSessionId) return;
    const currentName = state.sessions[state.currentSessionId].name;
    showCustomPrompt("Nh·∫≠p t√™n m·ªõi cho phi√™n:", currentName, (newName) => {
        if (newName && newName.trim() !== "") {
            state.sessions[state.currentSessionId].name = newName.trim();
            saveState();
            updateSessionSelector();
        }
    });
}
function deleteSelectedSession() {
    if (!state.currentSessionId || Object.keys(state.sessions).length <= 1) {
        showToast('Kh√¥ng th·ªÉ x√≥a phi√™n cu·ªëi c√πng.', 'warning');
        return;
    }
    showCustomConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phi√™n n√†y? D·ªØ li·ªáu c·ªßa phi√™n s·∫Ω m·∫•t vƒ©nh vi·ªÖn.', () => {
        delete state.sessions[state.currentSessionId];
        const newCurrentId = Object.keys(state.sessions)[0];
        loadSession(newCurrentId);
        showToast('ƒê√£ x√≥a phi√™n th√†nh c√¥ng.', 'success');
    });
}
function loadSession(sessionId) {
    state.currentSessionId = sessionId;
    state.lastPrediction = null;
    updateSessionSelector();
    const session = state.sessions[sessionId];
    document.getElementById('totalGames').textContent = session.history.length;
    renderAllRoads();
    triggerCombinedAnalysis();
    saveState();
}
function exportData() {
    const dataStr = JSON.stringify(state.sessions, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = 'baccarat_sessions.json';
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedSessions = JSON.parse(e.target.result);
            if (typeof importedSessions !== 'object' || importedSessions === null) throw new Error("Invalid format");
            showCustomConfirm('D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®. B·∫°n c√≥ ch·∫Øc mu·ªën ti·∫øp t·ª•c?', () => {
                state.sessions = importedSessions;
                const firstSessionId = Object.keys(state.sessions)[0];
                if(firstSessionId) {
                    loadSession(firstSessionId);
                } else {
                    createNewSession();
                }
                saveState();
                showToast('Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
            });
        } catch (error) {
            showToast('L·ªói: File d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.', 'error');
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

// --- SETTINGS & HELP MODALS ---
function openSettingsModal() {
    showModal(
        'C√†i ƒê·∫∑t API Key',
        `<div>
            <label for="apiKeyInput" class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key</label>
            <input type="password" id="apiKeyInput" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" value="${state.apiKey}">
            <p class="text-xs text-gray-500 mt-2">API Key c·ªßa b·∫°n ƒë∆∞·ª£c l∆∞u an to√†n tr√™n tr√¨nh duy·ªát n√†y. <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">L·∫•y API Key t·∫°i ƒë√¢y</a>.</p>
        </div>`,
        `<button onclick="closeModal()" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">H·ªßy</button>
         <button onclick="saveSettings()" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg">L∆∞u</button>`
    );
}

function openHelpModal() {
     showModal(
        'H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng',
        `<div class="text-sm text-gray-300 space-y-3">
            <p>ƒê√¢y l√† h·ªá th·ªëng ph√¢n t√≠ch Baccarat t·ªïng h·ª£p, k·∫øt h·ª£p 2 ph∆∞∆°ng ph√°p:</p>
            <ul class="list-disc list-inside space-y-2 pl-2">
                <li><strong class="text-yellow-400">Ph√¢n T√≠ch L·ªãch S·ª≠:</strong> H·ªá th·ªëng so s√°nh h√¨nh c·∫ßu hi·ªán t·∫°i v·ªõi TO√ÄN B·ªò d·ªØ li·ªáu b·∫°n ƒë√£ nh·∫≠p t·ª´ tr∆∞·ªõc ƒë·∫øn nay ƒë·ªÉ t√¨m ra c√°c quy lu·∫≠t th·ªëng k√™.</li>
                <li><strong class="text-cyan-400">Ph√¢n T√≠ch AI:</strong> Tr√≠ tu·ªá nh√¢n t·∫°o Gemini s·∫Ω "nh√¨n" v√†o c√°c b·∫£ng c·∫ßu v√† k·∫øt qu·∫£ th·ªëng k√™ ƒë·ªÉ ƒë∆∞a ra nh·∫≠n ƒë·ªãnh c·ªßa m·ªôt chuy√™n gia, t√¨m ra c√°c quy lu·∫≠t ·∫©n m√† th·ªëng k√™ c√≥ th·ªÉ b·ªè l·ª°.</li>
            </ul>
            <p><strong class="text-green-400">C√°ch ho·∫°t ƒë·ªông:</strong> M·ªói khi b·∫°n nh·∫≠p k·∫øt qu·∫£, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ch·∫°y c·∫£ 2 b·ªô m√°y ph√¢n t√≠ch v√† t·ªïng h·ª£p ch√∫ng l·∫°i ƒë·ªÉ ƒë∆∞a ra ƒë·ªÅ xu·∫•t cu·ªëi c√πng.</p>
            <p><strong class="text-red-400">L∆∞u √Ω:</strong> C√¥ng c·ª• ch·ªâ mang t√≠nh ch·∫•t tham kh·∫£o, d·ª±a tr√™n d·ªØ li·ªáu l·ªãch s·ª≠ v√† ph√¢n t√≠ch AI. Lu√¥n t·ª± ƒë∆∞a ra quy·∫øt ƒë·ªãnh cu·ªëi c√πng.</p>
        </div>`,
        `<button onclick="closeModal()" class="btn w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg">ƒê√£ hi·ªÉu</button>`
     );
}

function saveSettings() {
    state.apiKey = document.getElementById('apiKeyInput').value.trim();
    saveState();
    closeModal();
    showToast('ƒê√£ l∆∞u API Key!', 'success');
    triggerCombinedAnalysis(); // Re-run analysis after saving key
}

// --- GENERIC UI COMPONENTS (MODAL, TOAST, PROMPT) ---
function showModal(title, content, footer) {
    const container = document.getElementById('modal-container');
    container.innerHTML = `
        <div id="generic-modal" class="modal-backdrop">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-bold text-blue-300">${title}</h2>
                     <button onclick="closeModal()" class="text-gray-500 hover:text-white text-3xl">&times;</button>
                </div>
                ${content}
                <div class="mt-8 flex justify-end gap-4">${footer}</div>
            </div>
        </div>
    `;
}
function closeModal() { document.getElementById('modal-container').innerHTML = ''; }
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const colors = { success: 'border-green-500', info: 'border-blue-500', warning: 'border-yellow-500', error: 'border-red-500' };
    toast.className = `toast-notification ${colors[type]}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 3000);
}
function showCustomConfirm(message, onConfirm) {
    showModal('X√°c Nh·∫≠n H√†nh ƒê·ªông', `<p class="text-lg text-gray-200">${message}</p>`,
        `<button onclick="closeModal()" class="btn bg-gray-600 hover:bg-gray-500 px-6 py-2 rounded-lg">H·ªßy</button>
         <button id="confirm-ok" class="btn bg-red-600 hover:bg-red-500 px-6 py-2 rounded-lg">X√°c nh·∫≠n</button>`);
    document.getElementById('confirm-ok').onclick = () => { onConfirm(); closeModal(); };
}
function showCustomPrompt(message, defaultValue, onConfirm) {
    showModal('Nh·∫≠p Th√¥ng Tin',
        `<p class="text-lg text-gray-200 mb-4">${message}</p>
         <input type="text" id="prompt-input" value="${defaultValue}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">`,
        `<button onclick="closeModal()" class="btn bg-gray-600 hover:bg-gray-500 px-6 py-2 rounded-lg">H·ªßy</button>
         <button id="prompt-ok" class="btn bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg">L∆∞u</button>`);
    const input = document.getElementById('prompt-input');
    input.focus();
    input.select();
    document.getElementById('prompt-ok').onclick = () => { onConfirm(input.value); closeModal(); };
    input.onkeydown = (e) => { if (e.key === 'Enter') document.getElementById('prompt-ok').click(); };
}


// --- INITIALIZATION ---
function initializeApp() {
    loadState();
    updateSessionSelector();
    const session = state.sessions[state.currentSessionId];
    document.getElementById('totalGames').textContent = session.history.length;
    renderAllRoads();
    triggerCombinedAnalysis();
}

document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>

